services:
  # WhatsApp Web.js Gateway - Personal WhatsApp API
  # QR code will be shown in container logs: docker-compose logs -f wpp-gateway
  # Official WPPConnect Server
  wppconnect:
    image: wppconnect/server-cli:latest
    container_name: wppconnect
    restart: always
    ports:
      - "21465:21465"
    environment:
      - WEBHOOK=http://whatsapp_agent:8082/webhook/wpp
      - SERVER_PORT=21465
      - SECRET_KEY=${WPP_SECRET_KEY:-mysecurekey}
      - TOKEN=${WPP_TOKEN:-mysecuretoken}
      - LOG_LEVEL=ERROR
    networks:
      - whatsapp_network
    volumes:
      - wpp_tokens:/usr/src/app/tokens
      - wpp_data:/usr/src/app/.wppconnect

  # Python B2B Operations Manager Agent
  whatsapp_agent:
    build: .
    container_name: whatsapp_agent
    restart: always
    ports:
      - "8082:8082"
    environment:
      # Meta WhatsApp API (get from developers.facebook.com)
      - META_API_TOKEN=${META_API_TOKEN}
      - META_PHONE_NUMBER_ID=${META_PHONE_NUMBER_ID}
      # Google Cloud / Vertex AI
      - GOOGLE_PROJECT_ID=${GOOGLE_PROJECT_ID}
      - GOOGLE_LOCATION=${GOOGLE_LOCATION:-us-central1}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash-001}
      # Google Sheets
      - SPREADSHEET_ID=${SPREADSHEET_ID}
      - DRIVE_ROOT_FOLDER_ID=${DRIVE_ROOT_FOLDER_ID}
      # Clients file for name lookup
      - CLIENTS_FILE=/app/clients.json
      # B2B Operations Manager
      - CAST_WHATSAPP_MESSAGES=true
      # WPP Gateway Configuration (official server)
      - WPP_BASE_URL=http://wppconnect:21465
      - WPP_SESSION=${WPP_SESSION:-default}
      - WPP_SECRET_KEY=${WPP_SECRET_KEY:-mysecurekey}
    volumes:
      - ./service-account.json:/app/service-account.json:ro
      - ./clients.json:/app/clients.json
    networks:
      - whatsapp_network
    depends_on:
      - wppconnect

networks:
  whatsapp_network:
    driver: bridge

volumes:
  wpp_tokens:
  wpp_data:
